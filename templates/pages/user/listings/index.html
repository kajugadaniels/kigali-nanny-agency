{% extends 'layouts/app.html' %}

{% block content %}

    <section class="box-section background-body pt-80">
        <div class="container">
            <div class="text-center">
                <div class="background-body px-3 py-2 rounded-12 border d-flex gap-3 d-inline-flex">
                    <a href="{% url 'auth:profile' %}" class="neutral-700 text-md-medium">Home</a>
                    <span>
                        <img src="https://carento-demo.vercel.app/assets/imgs/template/icons/arrow-right.svg" alt="Carento" />
                    </span>
                    <a href="#" class="neutral-1000 text-md-bold">Job Listings</a>
                </div>
                <h3 class="mt-3 neutral-1000">Job Listings</h3>
            </div>
        </div>
    </section>

    <section class="box-section background-body pt-80 pb-110 dashboard">
        <div class="container">
            <div class="row">
                {% include 'inc/user-sidebar.html' %}

                <div class="col-xl-9 col-lg-8">
                    <div class="row">
                        <div class="col-xl-12 d-flex">
                            <div class="card shadow-none flex-fill">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="neutral-1000 text-md-bold fs-5">Job Listings</span>
                                        <div class="d-flex gap-2">
                                            <!-- Search Input -->
                                            <div class="input-icon-start position-relative">
                                                <span class="icon-addon">
                                                    <i class="fi fi-rr-search"></i>
                                                </span>
                                                <input type="text" id="search-input" class="input-small" placeholder="Search job title or location">
                                            </div>

                                            <!-- Status Filter Dropdown -->
                                            <div class="dropdown">
                                                <select id="status-filter" class="form-select">
                                                    <option value="">Select Status</option>
                                                    <option value="open">Open</option>
                                                    <option value="closed">Closed</option>
                                                    <option value="pending">Pending</option>
                                                    <option value="in_progress">In Progress</option>
                                                </select>
                                            </div>

                                            <!-- Sort Filter Dropdown -->
                                            <div class="dropdown">
                                                <select id="sort-filter" class="form-select">
                                                    <option value="newest">Sort by: Newest</option>
                                                    <option value="oldest">Sort by: Oldest</option>
                                                </select>
                                            </div>

                                        </div>
                                        <a href="{% url 'base:addJobListing' %}" class="btn btn-primary">
                                            Add New Job
                                        </a>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <div class="card shadow-none mb-2">
                                        <div class="table-responsive">
                                            <table class="table datatable table-striped" id="job-listings-table">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Job Title & Salary</th>
                                                        <th>Time (Months)</th>
                                                        <th>Address</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for job in job_postings %}
                                                        <tr>
                                                            <td><a href="javascript:void(0);" class="text-primary-dark fw-medium">#{{ job.id }}</a></td>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <a href="#" class="avatar avatar-lg">
                                                                        <img src="https://carento-demo.vercel.app/assets/imgs/cars-listing/cars-listing-6/car-1.png" class="img-fluid" alt="img">
                                                                    </a>
                                                                    <div class="ms-2">
                                                                        <p class="text-dark mb-0 fw-medium fs-14">
                                                                            <a href="#">{{ job.title }}</a>
                                                                        </p>
                                                                        <span class="fs-14 fw-normal neutral-500">{{ job.salary }} RWF</span>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td>{{ job.start_date|date:"F j, Y" }} - {{ job.end_date|date:"F j, Y" }}</td>
                                                            <td>{{ job.location }}</td>
                                                            <td>
                                                                {% if job.status == 'open' %}
                                                                    <span class="badge badge-success rounded-pill d-inline-flex align-items-center fs-10">
                                                                        <i class="fi fi-rr-check-circle me-1"></i> Open
                                                                    </span>
                                                                {% elif job.status == 'closed' %}
                                                                    <span class="badge badge-danger rounded-pill d-inline-flex align-items-center fs-10">
                                                                        <i class="fi fi-rr-door-closed me-1"></i> Closed
                                                                    </span>
                                                                {% elif job.status == 'pending' %}
                                                                    <span class="badge badge-warning rounded-pill d-inline-flex align-items-center fs-10">
                                                                        <i class="fi fi-rr-hourglass me-1"></i> Pending
                                                                    </span>
                                                                {% elif job.status == 'in_progress' %}
                                                                    <span class="badge badge-info rounded-pill d-inline-flex align-items-center fs-10">
                                                                        <i class="fi fi-rr-caret-right me-1"></i> In Progress
                                                                    </span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <a href="{% url 'base:editJobListing' job.slug %}" class="px-2">
                                                                        <i class="fi fi-rr-attribution-pencil"></i> Edit
                                                                    </a>
                                                                    <a href="{% url 'base:deleteJobListing' job.slug %}" class="px-2">
                                                                        <i class="fi fi-rr-recycle-bin"></i> Delete
                                                                    </a>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        <!-- Pagination -->
                                        <nav aria-label="Page navigation example" id="pagination-container">
                                            <ul class="pagination">
                                                {% for page_num in job_postings.paginator.page_range %}
                                                    <li class="page-item {% if job_postings.number == page_num %}active{% endif %}">
                                                        <a class="page-link" href="javascript:void(0);" onclick="loadPage({{ page_num }})">{{ page_num }}</a>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

{% endblock content %}

{% block extra_js %}
<script>
    // Function to load job listings based on selected filters and pagination
    function loadListings(page = 1) {
        const statusFilter = document.querySelector('#status-filter').value;
        const sortBy = document.querySelector('#sort-filter').value;
        const searchQuery = document.querySelector('#search-input').value;

        const url = new URL(window.location.href);
        const params = new URLSearchParams();

        if (statusFilter) params.append('status', statusFilter);
        if (sortBy) params.append('sort', sortBy);
        if (searchQuery) params.append('search', searchQuery);
        params.append('page', page);

        url.search = params.toString();

        fetch(url)
            .then(response => response.text())
            .then(data => {
                // Update the job listings table with the new data
                document.querySelector('#job-listings-table').innerHTML = data;
            });
    }

    // Event listener for filter changes
    document.querySelector('#status-filter').addEventListener('change', function () {
        loadListings();
    });

    document.querySelector('#sort-filter').addEventListener('change', function () {
        loadListings();
    });

    document.querySelector('#search-input').addEventListener('keyup', function () {
        loadListings();
    });

    // Pagination handling
    function loadPage(page) {
        loadListings(page);
    }

    // Initial load on page load
    loadListings();
</script>
{% endblock %}
